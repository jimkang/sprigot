function createCamera(t){var e={locked:!1,rootSelection:null,boardSelection:null,zoomBehavior:null,parsedPreLockTransform:null,scaleExtent:t,setUpZoomOnBoard:function(t,i){var n=this.getActualWidth(t.node()),o=this.getActualHeight(t.node()),r=d3.scale.linear().domain([0,n]).range([0,n]),s=d3.scale.linear().domain([0,o]).range([o,0]);e.zoomBehavior=d3.behavior.zoom().x(r).y(s).scaleExtent(this.scaleExtent).on("zoom",e.syncZoomEventToTransform),e.boardSelection=t,e.boardSelection.call(e.zoomBehavior),e.rootSelection=i},syncZoomEventToTransform:function(){e.locked||e.rootSelection.attr("transform","translate("+d3.event.translate+")"+" scale("+d3.event.scale+")")},resetZoom:function(){e.locked||rootSelection.attr("transform","translate(0, 0) scale(1)")},lockZoomToDefault:function(){e.resetZoom(),e.locked=!0},lockZoom:function(){e.locked=!0},unlockZoom:function(){e.locked=!1,e.parsedPreLockTransform&&(e.tweenToNewZoom(e.parsedPreLockTransform.scale,e.parsedPreLockTransform.translate,300),e.parsedPreLockTransform=null)},lockZoomToDefaultCenterPanAtDataCoords:function(t){e.parsedPreLockTransform=e.parseScaleAndTranslateFromTransformString(e.rootSelection.attr("transform")),e.panToCenterOnRect(t),e.lockZoom()},panToCenterOnRect:function(t,i,n){i||(i=300);var o=this.getActualWidth(this.boardSelection.node()),r=this.getActualHeight(this.boardSelection.node()),s=1,a=e.rootSelection.attr("transform");if(a){var d=e.parseScaleAndTranslateFromTransformString(a);s=d.scale}e.tweenToNewZoom(s,[-t.x-t.width/2+o/2,-t.y-t.height/2+r/2],i,n)},tweenToNewZoom:function(t,i,n,o){var r=e.rootSelection.attr("transform"),s=d3.transition().duration(n).tween("zoom",function(){var n=1,o=[0,0];if(r){var s=e.parseScaleAndTranslateFromTransformString(r);n=s.scale,o=s.translate}var a=d3.interpolate(n,t);return interpolateTranslation=d3.interpolate(o,i),function(t){var i=a(t);e.zoomBehavior.scale(i);var n=interpolateTranslation(t);e.zoomBehavior.translate(n),e.rootSelection.attr("transform","translate("+n[0]+", "+n[1]+")"+" scale("+i+")")}});o&&s.each("end",o)},parseScaleAndTranslateFromTransformString:function(t){var e={scale:1,translate:[0,0]};if(t&&t.length>0){var i=t.split("scale(")[1];i&&(e.scale=parseFloat(i.substr(0,i.length-1)));var n=t.split(") ")[0].split(",");e.translate=[parseFloat(n[0].substr(10)),parseFloat(n[1])],e.translate[1]||console.log("Got NaN out of",n)}return e},getActualHeight:function(t){var e=t.clientHeight;return 1>e&&(e=t.parentNode.clientHeight),e},getActualWidth:function(t){var e=t.clientWidth;return 1>e&&(e=t.parentNode.clientWidth),e},translateYFromSel:function(t){return t.attr("transform").split(",")[1].split(".")[0]},translateXFromSel:function(t){return t.attr("transform").split(",")[0].split(".")[0].split("(")[1]},panToElement:function(t,i){var n=e.zoomBehavior.scale(),o=parseInt(e.translateYFromSel(t))*n,r=parseInt(e.translateXFromSel(t))*n;e.panToCenterOnRect({x:r,y:o,width:1,height:1},750,i)}};return e}function uid(t){for(var e=[],i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=i.length,o=0;t>o;++o)e.push(i[getRandomInt(0,n-1)]);return e.join("")}function getRandomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function createAPIEnvoy(t){var e={serverURL:t,queuesForIntervals:{}};return e.request=function(t,e){var i=new XMLHttpRequest;i.open("POST",this.serverURL),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("accept","application/json"),i.onload=function(){if(200===this.status){var t=JSON.parse(this.responseText);e(null,t)}else e(this.status,null)},i.send(JSON.stringify(t))},e.addRequestToQueue=function(t,e,i){var n=queuesForIntervals.toString(),o=null;n in this.queuesForIntervals?o=this.queuesForIntervals[n]:(o=[],this.queuesForIntervals[n]=o),o.push({jsonBody:e,done:i})},e}function OKCancelDialog(t,e,i,n,o){this.parentSelector=t,this.text=e,this.okText=i,this.respondToOK=n,this.cleanUpFunction=o}function createStore(){var t={apienvoy:createAPIEnvoy("http://192.241.250.38")};return t.saveSprigFromTreeNode=function(t,e){var i=null;if(t&&(i=D3SprigBridge.serializeTreedNode(t)),i){var n=TextStuff.makeId(4),o={};i.doc=e,o[n]={op:"saveSprig",params:i},this.apienvoy.request(o,function(t,e){return t?(console.log("Error while saving sprig:",t),void 0):(n in e&&"saved"===e[n].status?console.log("Sprig saved:",e):console.log("Sprig not saved."),void 0)})}},t.saveChildAndParentSprig=function(t,e){var i={};i.saveChildSprigOp={op:"saveSprig",params:t},i.saveParentSprigOp={op:"saveSprig",params:e},this.apienvoy.request(i,function(t,e){return t?(console.log("Error while saving sprigs:",t),void 0):(console.log("Child sprig save status:",e.saveChildSprigOp.status),console.log("Parent sprig save status:",e.saveParentSprigOp.status),void 0)})},t.deleteChildAndSaveParentSprig=function(t,e){var i={};i.deleteChildSprigOp={op:"deleteSprig",params:t},i.saveParentSprigOp={op:"saveSprig",params:e},this.apienvoy.request(i,function(t,e){return t?(console.log("Error while saving sprigs:",t),void 0):(console.log("Sprig deletion status:",e.deleteChildSprigOp.status),console.log("Parent sprig save status:",e.saveParentSprigOp.status),void 0)})},t.getDoc=function(t,e){var i={op:"getDoc",params:{id:t,childDepth:0}};this.apienvoy.request({getDocReq:i},function(t,i){return t?(e&&e(t,null),void 0):("getDocReq"in i&&"got"===i.getDocReq.status?e&&e(null,i.getDocReq.result):e&&e(null,null),void 0)})},t.getSprigTree=function(t,e){var i={op:"getDoc",params:{id:t,childDepth:40}};this.apienvoy.request({getDocReq:i},function(t,i){return t?(e&&e(t,null),void 0):("getDocReq"in i&&"got"===i.getDocReq.status?e&&e(null,i.getDocReq.result.sprigTree):e&&e(null,null),void 0)})},t.getSprigList=function(t,e){var i={op:"getDoc",params:{id:t,flatten:!0}};this.apienvoy.request({getDocReq:i},function(t,i){return t?(e&&e(t,null),void 0):("getDocReq"in i&&"got"===i.getDocReq.status?e&&e(null,i.getDocReq.result.sprigList):e&&e(null,null),void 0)})},t.createNewDoc=function(t,e,i){var n={},o="docCreateReq"+uid(4),r="rootSprigSaveReq"+uid(4);n[o]={op:"saveDoc",params:t},n[r]={op:"saveSprig",params:e},this.apienvoy.request(n,i)},t}function translateTransform(t,e){return"translate("+t+", "+e+")"}function wrap(t,e,i){t.each(function(t){for(var n,o=d3.select(this),r=e(t).split(/\s+/).reverse(),s=[],a=1.1,d=o.attr("y"),l=parseFloat(o.attr("dy")),c=o.text(null).append("tspan").attr("x",0).attr("y",d).attr("dy",l+"em"),h=[c];n=r.pop();)s.push(n),c.text(s.join(" ")),c.node().getComputedTextLength()>i&&(s.pop(),c.text(s.join(" ")),s=[n],c=o.append("tspan").attr("x",0).attr("y",d).text(n),h.push(c));for(var p=0;p<h.length;++p){var u=h[p];u.attr("dy",l-(h.length-p-1)*a+"em")}})}function createTreeNav(){var t={sprigTree:null,graphCamera:null,treeRenderer:null,graph:null,textStuff:null};return t.init=function(t,e,i,n,o){this.sprigTree=t,this.graphCamera=e,this.treeRenderer=i,this.graph=n,this.textStuff=o},t.chooseTreeNode=function(t,e,i){this.expandChildren(t),this.graph.focusOnTreeNode(t,e,i),this.textStuff.showTextpaneForTreeNode(t)},t.toggleChildren=function(t){t.children?(t._children=t.children,t.children=null):this.expandChildren(t)},t.expandChildren=function(t){t._children&&(t.children=t._children,t._children=null)},t.collapseRecursively=function(e){e.children&&(e._children=e.children,e._children.forEach(t.collapseRecursively),e.children=null)},t.nodeIsExpanded=function(t){return t.children&&!t._children},t.followBranchOfNode=function(t){var e=null;if("object"==typeof t.children)for(var i=t.children.length-1;i>=0&&(e=t.children[i],"boolean"!=typeof e.emphasized||!e.emphasized);--i);if(e){var n=d3.select("#"+e.id).node();this.chooseTreeNode(e,n)}},t.followParentOfNode=function(t,e){if("object"==typeof t.parent){var i=d3.select("#"+t.parent.id);this.chooseTreeNode(t.parent,i.node()),this.graphCamera.panToElement(i,e)}},t.moveToSiblingNode=function(t,e,i){if("object"==typeof t.parent&&"object"==typeof t.parent.children){var n=t.parent.children.indexOf(t),o=n+e;if(o>-1&&o<t.parent.children.length){var r=t.parent.children[o],s=d3.select("#"+r.id).node();r._children&&this.expandChildren(r),this.graph.focusOnTreeNode(r,s,i),this.textStuff.showTextpaneForTreeNode(r)}}},t.goToSprigId=function(t,e){var i=D3SprigBridge.mapPathToSprigId(t,this.sprigTree,100);if(i.length>0){var n=i[i.length-1];this.graph.focusNode&&n.id===this.graph.focusNode.id||this.followPathToSprig(i,e,function(){this.textStuff.showTextpaneForTreeNode(n)}.bind(this))}},t.followPathToSprig=function(t,e,i){if(!e)var e=this.treeRenderer.treeNodeAnimationDuration-200;t.forEach(function(t){this.expandChildren(t)}.bind(this)),this.treeRenderer.update(this.sprigTree,0),this.graph.focusOnSprig(t[t.length-1].id,e,i)},t.respondToDownArrow=function(){d3.event.stopPropagation(),this.nodeIsExpanded(this.graph.focusNode)?this.followBranchOfNode(this.graph.focusNode):this.chooseTreeNode(this.graph.focusNode,d3.select("#"+this.graph.focusNode.id).node())},t.respondToUpArrow=function(){d3.event.stopPropagation(),this.followParentOfNode(this.graph.focusNode)},t.respondToLeftArrow=function(){d3.event.stopPropagation(),this.moveToSiblingNode(this.graph.focusNode,-1)},t.respondToRightArrow=function(){d3.event.stopPropagation(),this.moveToSiblingNode(this.graph.focusNode,1)},t}function createGraph(){var t={camera:null,treeRenderer:null,treeNav:null,textStuff:null,historian:null,sprigot:null,pane:null,board:null,svgRoot:null,focusEl:null,focusNode:null,nodeRoot:null,margin:{top:20,right:10,bottom:20,left:10}};return t.init=function(t,e,i,n,o,r){this.camera=e,this.treeRenderer=i,this.treeNav=createTreeNav(),this.textStuff=n,this.historian=o,this.sprigot=r,this.pane=t.append("div").attr("id","graphPane").classed("pane",!0),this.board=this.pane.append("svg").attr({id:"svgBoard",width:"100%",height:"85%"}),this.setUpFilters(),this.board.append("g").attr("id","background").append("rect").attr({width:"100%",height:"100%",fill:"rgba(0, 0, 16, 0.2)"}),this.svgRoot=this.board.append("g").attr({id:"graphRoot",transform:"translate("+this.margin.left+","+this.margin.top+")"}),this.camera.setUpZoomOnBoard(this.board,this.svgRoot),this.setGraphScale();var s=this.pane.append("div").attr("id","zoom-note").classed("info-note",!0);return this.sprigot.isMobile()?s.text("You can pinch to zoom in and out of the graph. Drag to pan."):s.text("You can use the mouse wheel to zoom in and out of the graph. Drag to pan."),this},t.setUpFilters=function(){var t=this.board.append("defs").append("filter").attr({id:"text-glow",x:"-20%",y:"-20%",width:"140%",height:"140%"});t.append("feGaussianBlur").attr({"in":"SourceAlpha",stdDeviation:4,result:"blurOut"});var e=t.append("feComponentTransfer").attr({"in":"blurOut",result:"increaseOpacityOut"});e.append("feFuncA").attr({type:"gamma",exponent:.7,amplitude:.8});var i=t.append("feMerge");i.append("feMergeNode").attr("in","increaseOpacityOut"),i.append("feMergeNode").attr("in","SourceGraphic")},t.loadNodeTreeToGraph=function(t,e,i){this.nodeRoot=t,this.treeRenderer.init(this.nodeRoot,this),this.treeNav.init(this.nodeRoot,this.camera,TreeRenderer,this,this.textStuff);var n=this.board.node().clientHeight-this.margin.top-this.margin.bottom;this.nodeRoot.x0=n/2,this.nodeRoot.y0=0,this.treeNav.collapseRecursively(this.nodeRoot);var o=this.nodeRoot;this.treeRenderer.update(this.nodeRoot);var r=!0;if(e){var s=D3SprigBridge.mapPathInD3Tree(e,this.nodeRoot,100);s.length>0&&(this.treeNav.followPathToSprig(s),o=s[s.length-1],r=!1)}r&&setTimeout(function(){this.panToRoot(),this.focusNode&&Historian.syncURLToSprigId(this.focusNode.id)}.bind(this),900),setTimeout(function(){this.noteNodeWasVisited(o),this.textStuff.initialShow(o),i()}.bind(this),800)},t.panToRoot=function(){var t=d3.select("#"+this.nodeRoot.id);this.setFocusEl(t.node()),this.camera.panToElement(t)},t.setGraphScale=function(){var t=this.camera.getActualHeight(this.board.node());230>=t&&(this.camera.rootSelection.attr("transform","translate(0, 0) scale(0.75)"),this.camera.zoomBehavior.scale(.5))},t.setFocusEl=function(t){this.focusEl=t,this.focusNode=d3.select(this.focusEl).datum()},t.focusOnTreeNode=function(t,e,i){this.setFocusEl(e);var n=this.noteNodeWasVisited(t);n||this.noteNodeWasVisited(t),this.historian.syncURLToSprigId(t.id),this.treeRenderer.update(this.nodeRoot),this.camera.panToElement(d3.select(this.focusEl),i)},t.focusOnSprig=function(t,e,i){e||(e=500);var n=d3.select("#"+t);setTimeout(function(){this.focusOnTreeNode(n.datum(),n.node(),i)}.bind(this),e)},t.nodeHasFocus=function(t){return t===this.focusNode},t.noteNodeWasVisited=function(t){var e="visited_"+t.id;localStorage[e]=!0},t.nodeWasVisited=function(t){var e="visited_"+t.id;return e in localStorage},t.nodeIsUnvisited=function(t){return!this.nodeWasVisited(t)},t.documentIsEditable=function(){return this.textStuff.editAvailable},t.nodeWasDragged=function(t){if(this.documentIsEditable()){var e=t.x-t.x0,i=t.y-t.y0;Math.abs(i)>Math.abs(e)&&this.swapNodeWithSibling(t,i>0?1:-1)}},t.swapNodeWithSibling=function(t,e){if("object"==typeof t.parent&&"object"==typeof t.parent.children){var i=_.indexOf(t.parent.children,t),n=i+e;if(n>-1&&n<t.parent.children.length){var o=t.parent.children[n];t.parent.children[i]=o,t.parent.children[n]=t,this.sprigot.store.saveSprigFromTreeNode(t.parent,t.parent.doc)}}},t}function createDivider(){var t={expanderArrow:null,graph:null,textStuff:null,camera:null,sprigot:null};return t.init=function(t,e,i,n,o){this.graph=e,this.textStuff=i,this.camera=n,this.sprigot=o,this.expanderArrow=t.append("div").classed("divider",!0).append("svg").classed("arrowboard",!0).append("polygon").attr({id:"expanderArrow",fill:"rgba(0, 0, 64, 0.4)",stroke:"#E0EBFF","stroke-width":1,points:"0,0 32,24 0,48",transform:"translate(0, 0)"}),this.expanderArrow.on("click",this.toggleGraphExpansion.bind(this))},t.syncExpanderArrow=function(){var t=this.textStuff.pane.classed("collapsedPane"),e=t?36:6,i="translate("+e+", 0) ",n=t,o=!1;i+="scale("+(n?"-1":"1")+", "+(o?"-1":"1")+") ",this.expanderArrow.transition().duration(500).ease("linear").attr("transform",i).attr("stroke-opacity",.5).attr("stroke-width",2).transition().delay(501).duration(500).attr("stroke-opacity",.15).attr("stroke-width",1)},t.toggleGraphExpansion=function(){var t=this.textStuff.pane.classed("collapsedPane"),e=!t;this.textStuff.pane.classed("collapsedPane",e).classed("pane",!e),this.graph.pane.classed("expandedPane",e).classed("pane",!e),this.textStuff.findUnreadLink.style("display",e?"none":"block"),this.syncExpanderArrow(),this.graph.focusEl&&this.camera.panToElement(d3.select(this.graph.focusEl))},t.hideGraph=function(){this.graph.pane.classed("expandedPane",!1),this.graph.pane.classed("collapsedPane",!0)},t}function loadATypeKit(t,e){var i=d3.select("head"),n=!0,o=i.append("script").attr({type:"text/javascript",src:t}),r=o.node();r.async=!0,r.onload=function(){function t(){n&&(console.log("needToRunDone is true."),n=!1,clearTimeout(s),e())}try{console.log("Typekit is loading."),Typekit.load({active:t,inactive:t})}catch(i){}};var s=setTimeout(function(){n?(console.log("Moving on."),n=!1,e()):console.log("Typekit already loaded.")},1e3)}function createSpriglog(t){var e={store:null,opts:t,spriglogSel:null,controllerType:"bloge",sprigList:[],sprigShowRange:[0,5],numberOfSprigsToRevealPerScrollEnd:5};return e.init=function(e){this.opts=t?t:{};var i=createSprigotBaseMixin(),n=i.setUpOuterContainer("bloge.css","bloge",this.opts);return n?(this.spriglogSel=d3.select(".bloge"),this.store=createStore(),loadATypeKit("//use.typekit.net/med0yzx.js",e),void 0):(setTimeout(e,0),void 0)},e.load=function(){Historian.init(null,this.opts.doc.id),this.store.getSprigList(this.opts.doc.id,function(t,e){t?this.opts.loadDone(t,null):e?(this.sprigList=e,this.sprigList.length<this.sprigShowRange[1]&&(this.sprigShowRange[1]=this.sprigList.length),this.render(e.slice(this.sprigShowRange[0],this.sprigShowRange[1])),window.onscroll=this.respondToScroll.bind(this),Historian.syncURLToSprigId(this.opts.doc.rootSprig),this.opts.loadDone()):this.opts.loadDone("Sprig tree not found.")}.bind(this))},e.render=function(t){var e=this.spriglogSel.selectAll(".sprig").data(t,function(t){return t.id}),i=e.enter().append("div").classed("sprig",!0).classed("textpane",!0);i.append("div").classed("title",!0),i.append("div").classed("sprigbody",!0),i.append("div").classed("stamps",!0),e.select(".title").text(function(t){return t.title}),e.select(".stamps").text(function(t){var e=new Date(t.created);return e.toLocaleString()}),e.select(".sprigbody").html(function(t){return t.body});var n=e.exit();n.remove()},e.respondToScroll=function(){document.body.scrollHeight-document.body.scrollTop===document.body.clientHeight&&this.sprigShowRange[0]+this.sprigShowRange[1]<this.sprigList.length&&(this.sprigShowRange[1]+=this.numberOfSprigsToRevealPerScrollEnd,this.sprigShowRange[0]+this.sprigShowRange[1]>=this.sprigList.length&&(this.sprigShowRange[1]=this.sprigList.length-this.sprigShowRange[0]),this.render(this.sprigList.slice(this.sprigShowRange[0],this.sprigShowRange[1])))},e}function createSprigotBaseMixin(){var t={};return t.setUpOuterContainer=function(t,e,i){var n=!1,o=d3.select(".outer-container");return(i.forceRebuild||!o.empty())&&(i.forceRebuild||!o.classed(e))&&(o.remove(),o=d3.select(".outer-container")),o.empty()&&(d3.select("head").append("link").attr({rel:"stylesheet",type:"text/css",href:t}),o=d3.select("body").append("section").classed("outer-container",!0).classed(e,!0),n=!0),n},t}function createSprigot(t){var e={graph:null,store:null,divider:null,camera:null,opts:t,controllerType:"sprigot"};return e.init=function(t){var e=createSprigotBaseMixin(),i=e.setUpOuterContainer("sprig.css","sprigot",this.opts);if(!i)return t(),void 0;var n=[.5,1];this.isMobile()&&(n=[.25,1]),this.camera=createCamera(n),this.graph=createGraph();var o=d3.select(".sprigot");this.graph.init(o,this.camera,TreeRenderer,TextStuff,Historian,this),this.store=createStore(),this.divider=createDivider(),this.divider.init(o,this.graph,TextStuff,this.camera,this),TextStuff.init(o,this.graph,TreeRenderer,this.store,this,this.divider),this.divider.syncExpanderArrow(),this.initDocEventResponders(),this.tagElementsWithCSSHackClasses(),loadATypeKit("//use.typekit.net/uoo5gyw.js",t)},e.load=function(){Historian.init(this.graph.treeNav,this.opts.doc.id),this.store.getSprigTree(this.opts.doc.id,function(t,e){if(t&&this.opts.loadDone(t,null),e){e=D3SprigBridge.sanitizeTreeForD3(e);var i=this.opts.initialTargetSprigId,n=function(){return!0};i&&(n=function(t){return i===t.id}),this.graph.loadNodeTreeToGraph(e,n,function(){"findunread"===i&&this.respondToFindUnreadCmd(),this.opts.loadDone()}.bind(this))}else this.opts.loadDone("Sprig tree not found.")}.bind(this))},e.initDocEventResponders=function(){var t=d3.select(document);TextStuff.editAvailable&&t.on("click",TextStuff.endEditing.bind(TextStuff)),t.on("keyup",this.respondToDocKeyUp.bind(this)),t.on("keydown",this.respondToDocKeyDown.bind(this))},e.respondToDocKeyUp=function(){if(27===d3.event.keyCode)d3.event.stopPropagation(),TextStuff.contentZone.classed("editing")&&TextStuff.changeEditMode(!1);else if(!TextStuff.contentZone.classed("editing"))switch(d3.event.which){case 69:d3.event.stopPropagation(),"block"===TextStuff.contentZone.style("display")&&TextStuff.changeEditMode(!0);break;case 40:this.graph.treeNav.respondToDownArrow();break;case 38:this.graph.treeNav.respondToUpArrow();break;case 37:this.graph.treeNav.respondToLeftArrow();break;case 39:this.graph.treeNav.respondToRightArrow();break;case 187:d3.event.shiftKey&&this.respondToAddChildSprigCmd();break;case 85:this.respondToFindUnreadCmd()}},e.respondToDocKeyDown=function(){TextStuff.editAvailable&&(d3.event.metaKey||d3.event.ctrlKey)&&8===d3.event.which&&TextStuff.showDeleteSprigDialog()},e.respondToAddChildSprigCmd=function(){d3.event.stopPropagation(),TextStuff.contentZone.classed("editing")&&TextStuff.changeEditMode(!1);var t=(new Date).toJSON(),e={id:TextStuff.makeId(8),doc:this.opts.doc.id,title:"New Sprig",body:"",created:t,modified:t},i=this.graph.focusNode.children;i||(i=this.graph.focusNode._children),i||(i=[]),i.push(e),this.graph.focusNode.children=i,TextStuff.changeEditMode(!0),this.store.saveChildAndParentSprig(e,D3SprigBridge.serializeTreedNode(this.graph.focusNode)),TreeRenderer.update(this.graph.nodeRoot,this.graph.treeRenderer.treeNodeAnimationDuration),setTimeout(function(){this.graph.focusOnSprig(e.id),TextStuff.showTextpaneForTreeNode(e)}.bind(this),this.graph.treeRenderer.treeNodeAnimationDuration+100)},e.respondToDeleteSprigCmd=function(){d3.event.stopPropagation(),TextStuff.contentZone.classed("editing")&&TextStuff.changeEditMode(!1,!0);var t=this.graph.focusNode.parent,e=t.children.indexOf(this.graph.focusNode);t.children.splice(e,1);var i={id:this.graph.focusNode.id,doc:this.opts.doc.id};this.store.deleteChildAndSaveParentSprig(i,D3SprigBridge.serializeTreedNode(t));var n=this.graph.treeNav;TreeRenderer.update(this.graph.nodeRoot,this.graph.treeRenderer.treeNodeAnimationDuration),setTimeout(function(){n.chooseTreeNode(t,d3.select("#"+t.id).node())},this.graph.treeRenderer.treeNodeAnimationDuration+500)},e.respondToNewSprigotCmd=function(){var t={id:uid(8),rootSprig:uid(8),authors:["deathmtn"],admins:["deathmtn"]},e={id:t.rootSprig,doc:t.id,title:"Root",body:"Hello. Type some stuff here.",children:[]};this.store.createNewDoc(t,e)},e.respondToFindUnreadCmd=function(){var t=D3SprigBridge.mapPathInD3Tree(this.graph.nodeIsUnvisited.bind(this.graph),this.graph.treeNav.sprigTree,100);if(t.length>0){(t.length>1||t[0].id!==this.graph.focusNode.id)&&this.graph.treeNav.followPathToSprig(t);var e=t[t.length-1];Historian.syncURLToSprigId(e.id),TextStuff.syncTextpaneWithTreeNode(e)}else TextStuff.disableFindUnreadLink()},e.respondToSwitchToGraphCmd=function(){this.graph.pane.classed("expandedPane")||this.divider.toggleGraphExpansion()},e.isMobile=function(){var t="only screen and (max-device-height: 568px)";return window.matchMedia(t).matches},e.tagElementsWithCSSHackClasses=function(){this.isMobile()&&!navigator.userAgent.match(/(iPad|iPhone);.*CPU.*OS 7_\d/i)&&(d3.select(".sprigot").classed("is-not-ios-seven",!0),d3.select("#graphPane").classed("is-not-ios-seven",!0),d3.select(".divider").classed("is-not-ios-seven",!0),d3.select("#nongraphPane").classed("is-not-ios-seven",!0))},e}function createNewDocForm(t){function e(t,e){function i(t){n[t.id]=o.select("#"+t.id).node().value}var n={},o=d3.select(t);return e.forEach(i),n}var i={docId:null,store:null,opts:t,newDocFormSel:null,controllerType:"form"};return i.init=function(e){this.opts=t?t:{};var i=createSprigotBaseMixin(),n=i.setUpOuterContainer("form.css","form",this.opts);return n?(this.newDocFormSel=d3.select(".form"),this.store=createStore(),loadATypeKit("//use.typekit.net/med0yzx.js",e),void 0):(e(),void 0)},i.load=function(){this.render([{title:"New Sprigot document",fields:[{id:"name",name:"Name",type:"text"},{id:"author",name:"Author",type:"text"},{id:"admin",name:"Admin",type:"text"},{id:"format",name:"Format",type:"select",options:["sprigot","bloge"]}],submit:{action:function(t){var e=createStore(),i={id:t.name,rootSprig:uid(8),authors:[t.author],admins:[t.author],format:t.format},n=(new Date).toJSON(),o={id:i.rootSprig,doc:i.id,title:t.name,body:"Hello. Type some stuff here.",children:[],created:n,modified:n};e.createNewDoc(i,o,function(t,e){t?console.log("Error while saving doc:",t):(console.log("Saved doc:",e),Director.direct("#/"+i.id+"/"+o.id+"?forceRebuild=true"))})},name:"Make it!"}}]),setTimeout(function(){t.loadDone()},0)},i.render=function(t){var i=this.newDocFormSel.selectAll(".sprig").data(t,function(t){return t.id}),n=i.enter().append("div").classed("sprig",!0).classed("textpane",!0);n.append("div").classed("title",!0);var o=n.append("div").classed("sprigbody",!0);i.select(".title").text(function(t){return t.title});var r=i.exit();r.remove(),o.each(this.setUpFields),o.append("button").classed("submit-button",!0).text(function(t){return t.submit.name}).on("click",function(t){var i=e(this.parentElement,t.fields);t.submit.action(i)})},i.setUpFields=function(t){var e=d3.select(this).selectAll(".field-group").data(t.fields),i=e.enter().append("div").classed("field-group",!0);i.append("label").attr({id:function(t){return t.id+"_label"},"for":function(t){return t.id}}).text(function(t){return t.name}),i.append("input").attr("id",function(t){return t.id}),e.exit().remove()},i}var Settings={defaultDoc:{id:"About"}};if("object"==typeof module)var _=require("underscore");D3SprigBridge={validSprigPropertyList:["id","doc","title","body","emphasize","created","modified"]},D3SprigBridge.serializeTreedNode=function(t){var e=_.pick(t,this.validSprigPropertyList),i=t.children;return t.children||(i=t._children),i&&(e.children=_.pluck(i,"id")),e},D3SprigBridge.sanitizeTreeForD3=function t(e){if("object"==typeof e.children){for(var i=[],n=[],o=0;o<e.children.length;++o){var r=e.children[o];"object"==typeof r?n.push(r):i.push(r)}i.length>0&&(e.childRefs=i),n.length>0&&(e.children=n,e.children.forEach(t))}return e},D3SprigBridge.mapPathToSprigId=function(t,e,i){function n(e){return e.id===t}return this.mapPathInD3Tree(n,e,i)},D3SprigBridge.mapPathInD3Tree=function(t,e,i){if(t(e))return[e];for(var n=[],o={},r=null,s=0,a=null,d=[e];i>=s;){a=[];for(var l=0;l<d.length;++l){var c=d[l];if(t(c)){r=c;break}if(i>=s+1&&c){var h=[];"object"==typeof c.children&&c.children?h=c.children:"object"==typeof c._children&&c._children&&(h=c._children),h.forEach(function(t){o[t.id]=c}),a=a.concat(h)}}if(r)break;s++,d=a}if(r)for(var c=r;c;)n.unshift(c),c=c.id in o?o[c.id]:null;return n},D3SprigBridge.flattenTreeBreadthFirst=function(t,e){e||(e=1e3);for(var i=[],n=0,o=null,r=[t];e>=n&&r.length>0;){o=[];for(var s=0;s<r.length;++s){var a=r[s];if(e>=n+1&&a){var d=[];"object"==typeof a.children&&a.children?d=a.children:"object"==typeof a._children&&a._children&&(d=a._children),o=o.concat(d)}i.push(this.serializeTreedNode(a))}n++,r=o}return i},"object"==typeof module&&(module.exports=D3SprigBridge),"object"==typeof module&&(module.exports.uid=uid),OKCancelDialog.prototype.show=function(){var t=d3.select(this.parentSelector).append("div").attr("id","OKCancelDialog").classed("notification",!0);t.append("p").attr("id","dialogText").text(this.text),t.append("button").attr("id","OKButton").text(this.okText?this.okText:"OK").on("click",this.respondToOKClick.bind(this)),t.append("button").attr("id","CancelButton").text("Cancel").on("click",this.respondToCancelClick.bind(this))},OKCancelDialog.prototype.respondToOKClick=function(){this.respondToOK(),this.cleanUpFunction&&this.cleanUpFunction(),d3.select(this.parentSelector).select("#OKCancelDialog").remove()},OKCancelDialog.prototype.respondToCancelClick=function(){this.cleanUpFunction&&this.cleanUpFunction(),d3.select(this.parentSelector).select("#OKCancelDialog").remove()};var TreeRenderer={treeLayout:null,diagonalProjection:null,sprigTree:null,graphSVGGroup:null,graph:null,treeNodeAnimationDuration:750,maxLabelWidth:140};TreeRenderer.init=function(t,e){this.treeLayout=d3.layout.tree(),this.treeLayout.nodeSize([160,160]),this.sprigTree=t,this.diagonalProjection=d3.svg.diagonal().projection(function(t){return[t.y,t.x]}),this.graph=e,this.graphSVGGroup=e.svgRoot},TreeRenderer.update=function(t,e){e||(e=this.treeNodeAnimationDuration);var n=this.treeLayout.nodes(this.sprigTree).reverse();n.forEach(function(t){var e=t.x,i=t.x0;t.x=t.y,t.x0=t.y0,t.y=e,t.y0=i});var o=this.treeLayout.links(n);n.forEach(function(t){t.x=180*t.depth});var r=this.graphSVGGroup.selectAll("g.node").data(n,function(t){return t.id||(t.id=++i)}),s=r.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+t.y0+","+t.x0+")"}).attr("id",function(t){return t.id}).on("click",TreeRenderer.respondToNodeClick).on("dblclick",this.onNodeDoubleClick.bind(this));this.graph.documentIsEditable()&&this.addDragToNodeSelection(s),s.append("circle").attr("r",1e-6).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}).style("fill-opacity",.7).style("stroke","rgba(0, 64, 192, 0.7)"),s.append("text").attr("x",function(t){return t.children||t._children?"0.3em":"-0.3em"}).attr("y","-1em").attr("dy",".35em").attr("text-anchor","middle").text(function(t){return t.title}).style("fill-opacity",1e-6);var a=r.transition().duration(e).attr("transform",function(t){return"translate("+t.y+","+t.x+")"});a.select("circle").attr("r",8).style("fill",function(t){var e="lightsteelblue";return this.graph.nodeHasFocus(t)?e="#e0362f":"boolean"==typeof t.emphasize&&t.emphasize&&(e="#08a"),e}.bind(this)).style("fill-opacity",function(t){var e=.7;return this.graph.nodeHasFocus(t)&&(e=1),e}.bind(this)).style("stroke-width",function(t){return t._children&&t._children.length>0?"32px":0}),a.select("text").style("fill-opacity",function(t){return this.graph.nodeHasFocus(t)?1:.78}.bind(this)).call(wrap,function(t){return t.title},this.maxLabelWidth);var d=r.exit().transition().duration(e).attr("transform",function(){return"translate("+t.y+","+t.x+")"}).remove();d.select("circle").attr("r",1e-6),d.select("text").style("fill-opacity",1e-6);var l=this.graphSVGGroup.selectAll("path.link").data(o,function(t){return t.target.id});l.enter().insert("path","g").attr("class","link").attr("d",function(){var e={x:t.x0,y:t.y0};return this.diagonalProjection({source:e,target:e})}.bind(this)),l.attr("d",this.diagonalProjection).attr("stroke-width",function(t){return this.graph.nodeWasVisited(t.target)?3:1.5}.bind(this)),l.exit().transition().duration(e).attr("d",function(){var e={x:t.x,y:t.y};return this.diagonalProjection({source:e,target:e})}.bind(this)).remove(),n.forEach(function(t){t.x0=t.x,t.y0=t.y})},TreeRenderer.respondToNodeClick=function(t){TreeRenderer.graph.treeNav.chooseTreeNode(t,this)},TreeRenderer.onNodeDoubleClick=function(t){this.graph.treeNav.toggleChildren(t),this.update(t)},TreeRenderer.addDragToNodeSelection=function(t){var e=d3.behavior.drag();e.on("dragstart",function(t){d3.event.sourceEvent.stopPropagation(),t.x0=t.x,t.y0=t.y}),e.on("drag",function(t){d3.event.sourceEvent.stopPropagation(),this.setAttribute("transform",translateTransform(d3.event.x,d3.event.y)),t.x=d3.event.y,t.y=d3.event.x}),e.on("dragend",function(t){d3.event.sourceEvent.stopPropagation(),this.graph.nodeWasDragged(t)}.bind(this)),t.call(e)};var TextStuff={graph:null,treeRenderer:null,store:null,sprigot:null,divider:null,sprigot:null,pane:null,textpane:null,textcontent:null,titleField:null,contentZone:null,addButton:null,deleteButton:null,newSprigotButton:null,emphasizeCheckbox:null,findUnreadLink:null,showGraphLink:null,downLink:null,OKCancelDialog:null,editAvailable:!1};TextStuff.init=function(t,e,i,n,o,r){this.graph=e,this.treeRenderer=i,this.store=n,this.sprigot=o,this.divider=r,this.pane=t.append("div").classed("pane",!0).attr("id","nongraphPane"),this.pane.append("div").attr("id","questionDialog"),this.textpane=this.pane.append("div").attr("id","textpane").classed("textpane",!0),this.contentZone=this.textpane.append("div").classed("contentZone",!0).style("display","none"),this.titleField=this.contentZone.append("span").classed("sprigTitleField",!0).style("display","none"),this.textcontent=this.contentZone.append("div").classed("textcontent",!0).attr("tabindex",0),this.editAvailable&&(this.addButton=this.textpane.append("button").text("+").classed("newsprigbutton",!0).classed("editcontrol",!0),this.deleteButton=this.textpane.append("button").text("-").classed("deletesprigbutton",!0).classed("editcontrol",!0),this.textpane.append("label").text("Emphasize").classed("editcontrol",!0),this.emphasizeCheckbox=this.textpane.append("input").attr({type:"checkbox",id:"emphasize"}).classed("editcontrol",!0),this.newSprigotButton=this.textpane.append("button").text("New Sprigot!").classed("editcontrol",!0)),this.initFindUnreadLink(),d3.selectAll("#textpane .contentZone,.editcontrol").style("display","none"),this.editAvailable&&(this.textcontent.on("click",this.startEditing.bind(this)),this.titleField.on("click",this.startEditing.bind(this)),this.addButton.on("click",this.sprigot.respondToAddChildSprigCmd.bind(this.sprigot)),this.deleteButton.on("click",this.showDeleteSprigDialog.bind(this)),this.emphasizeCheckbox.on("change",this.respondToEmphasisCheckChange.bind(this)),this.contentZone.on("keydown",this.respondTocontentZoneKeyDown.bind(this)),this.newSprigotButton.on("click",this.sprigot.respondToNewSprigotCmd.bind(this.sprigot)))
},TextStuff.initFindUnreadLink=function(){this.findUnreadLink=this.pane.append("a").attr("id","findunreadlink").classed("control-link",!0).classed("findunread-link",!0).text("Find Unread").style("display","none").on("click",this.sprigot.respondToFindUnreadCmd.bind(this.sprigot))},TextStuff.syncTextpaneWithTreeNode=function(t){this.textcontent.datum(t),this.titleField.datum(t),this.textcontent.html(t.body),this.titleField.html(t.title),this.editAvailable&&(this.emphasizeCheckbox.node().checked=this.graph.focusNode.emphasize),this.sprigot.isMobile()&&window.scrollTo(0,0)},TextStuff.showTextpaneForTreeNode=function(t){this.syncTextpaneWithTreeNode(t),d3.selectAll("#textpane .contentZone,.editcontrol").style("display","block"),this.contentZone.style("display","block"),this.uncollapseTextpane()},TextStuff.fadeInTextPane=function(t){if("none"===this.contentZone.style("display")){var e=d3.selectAll("#textpane .contentZone,.editcontrol");this.textpane.style("opacity",0),e.style("opacity",0),this.contentZone.style("opacity",0),e.style("display","block").transition().duration(t).style("opacity",1),this.contentZone.style("display","block").transition().duration(t).style("opacity",1),this.textpane.transition().duration(t).style("opacity",1)}},TextStuff.fadeInControlLinks=function(t){var e=d3.selectAll("#nongraphPane .control-link");e.style("opacity",0),e.style("display","block").transition().duration(t).style("opacity",1)},TextStuff.initialShow=function(t){setTimeout(function(){this.syncTextpaneWithTreeNode(t),this.fadeInTextPane(750),this.fadeInControlLinks(800)}.bind(this),725)},TextStuff.uncollapseTextpane=function(){var t=this.pane.classed("collapsedPane");t&&this.divider.toggleGraphExpansion()},TextStuff.showTitle=function(){this.titleField.text(this.titleField.datum().title),this.titleField.style("display","block")},TextStuff.disableFindUnreadLink=function(){this.findUnreadLink.text("You've read all the sprigs!"),this.findUnreadLink.transition().duration(700).style("opacity",.3).style("cursor","default").attr("href",null),this.findUnreadLink.transition().delay(3e3).duration(2e3).style("opacity",0)},TextStuff.makeId=function(t){return"s"+uid(t)},TextStuff.changeEditMode=function(t,e){if(this.editAvailable)if(this.textcontent.attr("contenteditable",t),this.titleField.attr("contenteditable",t),this.contentZone.classed("editing",t),t)this.showTitle(),this.textcontent.node().focus();else{this.titleField.style("display","none");var i=this.textcontent.datum();i.body=this.textcontent.html();var n=this.titleField.text(),o=n!==i.title;i.title=n,o&&d3.select("#"+i.id+" text").text(i.title),this.textcontent.datum(i),this.titleField.datum(i),e||this.store.saveSprigFromTreeNode(this.textcontent.datum(),this.sprigot.opts.doc.id)}},TextStuff.endEditing=function(){this.contentZone.classed("editing")&&this.changeEditMode(!1)},TextStuff.showDeleteSprigDialog=function(){this.OKCancelDialog=new OKCancelDialog("#questionDialog","Do you want to delete this?","Delete",this.sprigot.respondToDeleteSprigCmd.bind(this.sprigot),function(){delete this.OKCancelDialog}.bind(this)),this.OKCancelDialog.show()},TextStuff.respondToEmphasisCheckChange=function(){this.graph.focusNode&&(this.graph.focusNode.emphasize=this.emphasizeCheckbox.node().checked,this.treeRenderer.update(this.graph.nodeRoot),this.store.saveSprigFromTreeNode(this.graph.focusNode,this.sprigot.opts.doc.id))},TextStuff.respondTocontentZoneKeyDown=function(){(d3.event.metaKey||d3.event.ctrlKey)&&13===d3.event.which&&(d3.event.stopPropagation(),this.contentZone.classed("editing")&&this.changeEditMode(!1))},TextStuff.startEditing=function(){d3.event.stopPropagation(),this.contentZone.classed("editing")||this.changeEditMode(!0)};var Historian={docNav:null,docId:null};Historian.init=function(t,e){this.docNav=t,this.docId=e,window.onpopstate=this.statePopped.bind(this)},Historian.statePopped=function(t){t.state&&(this.docId=t.state.docId,this.docNav.goToSprigId(t.state.sprigId,100))},Historian.syncURLToSprigId=function(t){if("object"!=typeof window.history.state||!window.history.state||"string"!=typeof window.history.state.docId||"string"!=typeof window.history.state.sprigId||window.history.state.docId!==this.docId||window.history.state.sprigId!==t){var e=location.protocol+"//"+location.host+location.pathname+"#/"+this.docId+"/"+t;window.history.pushState({docId:this.docId,sprigId:t},null,e)}};var Director={sprigController:null,initialTargetSprigId:null,initialTargetDocId:null,store:createStore()};Director.setUpController=function(t,e){var i=t.format?t.format:"sprigot";this.sprigController&&this.sprigController.controllerType===i?(this.sprigController.opts=t,setTimeout(e,0)):(this.sprigController="bloge"===t.format?createSpriglog(t):"newdoc"===t.format?createNewDocForm(t):createSprigot(t),this.sprigController.init(e))},Director.direct=function(t){var e=this.dictFromQueryString(this.queryStringFromHash(t)),i=t.split("/");if(i.length<2)return this.directToDefault(e),void 0;switch(i[1]){case"index":break;case"new":e.format="newdoc",e.loadDone=this.loadDone.bind(this),this.setUpController(e,this.callLoad.bind(this));break;default:this.initialTargetDocId=i[1],this.store.getDoc(this.initialTargetDocId,function(t,n){t?console.log("Error",t):(e.format||(e.format=n.format),e.doc=n,i.length>1&&(e.initialTargetSprigId=i[2]),e.loadDone=this.loadDone.bind(this),this.setUpController(e,this.callLoad.bind(this)))}.bind(this))}},Director.loadDone=function(t){t&&console.log("Error while loading:",t)},Director.callLoad=function(){this.sprigController.load()},Director.directToDefault=function(t){t.doc=Settings.defaultDoc,t.loadDone=function(t){t&&console.log("Error while getting sprig:",t)},this.setUpController(t,this.callLoad.bind(this))},Director.respondToHashChange=function(){this.direct(location.hash)},Director.init=function(){this.direct(location.hash),window.onhashchange=this.respondToHashChange.bind(this)},Director.queryStringFromHash=function(t){var e=null,i=t.split("?");return i.length>1&&(e=i[1]),e},Director.dictFromQueryString=function(t){var e={};if(t&&"string"==typeof t)for(var i=t.split("&"),n=0;n<i.length;++n){var o=i[n],r=o.split("=");2===r.length&&(e[r[0]]=r[1])}return e},Director.init();